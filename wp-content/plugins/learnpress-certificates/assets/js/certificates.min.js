!function(e){var t,n,a,i,o,r,c,l;window.LP_Certificate=function(t,n){var a,i,o,l,s=this,d={width:0,height:0,templateWidth:0,templateHeight:0,ratio:1},f=e(t),u=null;var p="certificate";var h=0,g=0;function m(){if(++g===h){var t=n.template,s=new Image,p={};if(void 0!==localize_lp_cer_js)new RegExp("^"+localize_lp_cer_js.base_url).test(t)||(s.crossOrigin="Anonymous",p.crossOrigin="Anonymous");s.onload=function(){d={width:this.width,height:this.height},fabric.Image.fromURL(s.src,function(t){var s,p,h;u.backgroundImage=t,u.setHeight(d.height),u.setWidth(d.width),u.setZoom(d.ratio),u.calcOffset(),u.renderAll(),s={format:"png",multiplier:1/u.getZoom(),quality:1},p=u.toDataURL(s),h=e('<img class="certificate-result" />').insertBefore(f),l=e(".certificate-result"),h.attr("src",p),setTimeout(function(){h.width()>a&&l.css("width","100%")},100),c.length&&function(){var t={action:"lpCertCreateImage",data64:l.attr("src"),name_image:n.key_cer};e.ajax({url:localize_lp_cer_js.url_ajax,data:t,method:"post",dataType:"json",beforeSend:function(){i.append('<li class="fa fa-spinner">Loading share social...</li>')},success:function(t){1==t.code&&(e.each(r,function(n){var a=e(this).attr("href")+t.url_cert;e(this).attr("href",a)}),r.show())},complete:function(){i.find(".fa-spinner").remove()},error:function(e){console.log(e)}})}(),i.length&&(o=i.find(".download")),e(document).triggerHandler("learn-press/certificates/loaded")},p)},s.src=t}}e(window).height(),a=e(window).width(),i=e(".certificate-actions"),u||(u=f.find("canvas"),(u=new fabric.Canvas(u.get(0))).selection=!1,e.each(n.layers,function(e){h++}),e.each(n.layers,function(t,n){n.type&&e.isPlainObject(n)&&function(t){var n,a;t.text=(n=t.text,(a=document.createElement("div")).innerHTML=n,(0===a.childNodes.length?"":a.childNodes[0].nodeValue)||"");var i=e.extend({fontSize:24,left:0,top:0,lineHeight:1,originX:"center",originY:"center",fontFamily:"Helvetica",fieldType:"custom",qr_size:40},t);t.text;try{var o=null,r=/^(https?|s?ftp):\/\//i.test(t.text);if("verified-link"==t.fieldType&&r){var c=new Image;i.type="image",i.height=i.qr_size,i.width=i.qr_size,c.crossOrigin="Anonymous",c.onload=function(){o=new fabric.Image(c,i),u.add(o),m()},c.src=t.text}else o=new fabric.Text("",i),u.add(o),m()}catch(a){console.log(a)}}(n)})),e(document).on("click",'[data-cert="'+f.attr("id")+'"]',function(t){t.preventDefault(),function(){if(o.length){var t=o.data("type-download");switch(void 0!==n.name&&(p=n.name),t){case"pdf":!function(){if((l=e(".certificate-result")).length){var t=l.attr("src");!function(e,t){var n=new Image;n.onError=function(){alert('Cannot load image: "'+e+'"')},n.onload=function(){t(n,n.width,n.height)},n.src=e}(t,function(e,t,n){var a,i,o;t>=n?(a=new jsPDF("l","mm",[t,n]),i=a.internal.pageSize.getWidth(),o=n*i/t):(a=new jsPDF("p","mm",[t,n]),i=a.internal.pageSize.getWidth(),o=a.internal.pageSize.getHeight()),a.addImage(e,"png",0,0,i,o),a.save(p+".pdf")})}}();break;case"image":default:a={format:"png",multiplier:1/u.getZoom()},i=function(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),i=new Uint8Array(a),o=0;o<t.length;o++)i[o]=t.charCodeAt(o);return new Blob([a],{type:n})}(u.toDataURL()),r=new FormData,p+=".png",r.append("files",i,p),downloadjs(u.toDataURL(a),p)}}var a,i,r}()}),s.$canvas=u},e(document).ready(function(){if(t=e("html, body"),n=e(".lp-data-config-cer"),a=e("input[name=f_auto_show_cer_popup_first]"),i=e('form[name="certificate-form-button"]'),o=e("#certificate-popup"),e(".single-certificate-content"),r=e(".social-cert"),c=e("input[name=need_upload_cert_img_to_server]"),l=e("form[name=form-lp-cert-add-to-cart-woo]"),r.hide(),a.length||i.css("display","inline-block"),n.length)try{e.each(n,function(t){var n=JSON.parse(e(this).val())||{};e(this).val("");var a="#"+e(this).closest("div").attr("id");LP_Certificate(a,n)})}catch(e){console.log(e)}!function(){if(o.length){function n(){o.fadeOut(function(){t.css("overflow","auto")})}function r(){t.css("overflow","hidden"),o.fadeIn()}e(document).on("learn-press/certificates/loaded",function(){o.addClass("ready").hide(),t.off("keyup").on("keyup",function(e){27===e.keyCode&&n()}).off("click").on("click",".close-popup",function(e){n(),e.preventDefault()}),i.on("submit",function(e){e.preventDefault(),r()}),a.length&&r()})}}(),l.length&&l.on("submit",function(t){t.preventDefault(),$el_form_lp_cert_add_to_cart_woo=e(this);var n=e(this).find(".btn-add-cert-to-cart-woo"),a=e(this).serialize();a+="&action=lp_cert_add_to_cart_woo",e.ajax({url:localize_lp_cer_js.url_ajax,data:a,method:"post",beforeSend:function(){n.append('<span class="fa fa-spinner"></span>')},success:function(e){1===e.code?null!=e.redirect_to?window.location.replace(e.redirect_to):($el_form_lp_cert_add_to_cart_woo.closest(".wrapper-lp-cert-add-to-cart-woo").append(e.button_view_cart),$el_form_lp_cert_add_to_cart_woo.remove()):alert(e.message)},error:function(e){console.log(e)},complete:function(){n.find("span").remove()}})})})}(jQuery);
