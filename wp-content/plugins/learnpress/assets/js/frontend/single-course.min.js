"undefined"==typeof LearnPress&&(window.LP=window.LearnPress={}),function(e){"use strict";LearnPress.Course=e.extend(LearnPress.Course||{},{finish:function(e,t){LearnPress.$LP_Course&&LearnPress.$LP_Course.finishCourse({data:e,success:t})}});var t=function(e){this.model=new t.Model(e),this.view=new t.View({model:this.model})},n=function(t,n){var s,i={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"},o=function(n){return(s=s||_.template(e("#learn-press-template-"+t).html(),null,i))(n)};return n?e(o(n)):o},s=window.Course_Item=Backbone.Model.extend({initialize:function(){this.on("change:content",this._changeContent),this.on("change:current",this._changeCurrent)},_changeContent:function(){LP.Hook.doAction("learn_press_update_item_content",this)},_changeCurrent:function(e){},get:function(){var e=s.__super__.get.apply(this,arguments);return"url"==arguments[0]&&(e=LP_Course_Params.root_url+e),e},request:function(t){var n=this;return!!this.get("url")&&(t=e.extend({context:null,callback:null},t||{}),LP.ajax({url:this.get("url"),action:"load-item",data:e.extend({format:"html"},this.toJSON()),dataType:"html",success:function(s){LP.Hook.doAction("learn_press_course_item_loaded",s,n),s=LP.Hook.applyFilters("learn_press_course_item_content",s,n),e.isFunction(t.callback)&&t.callback.call(t.context,s,n)}}),this)},complete:function(t){var n=this;t=e.extend({context:null,callback:null,format:"json"},this.toJSON(),t||{});var s={};_.forEach(t,(function(t,n){-1!=e.inArray(n,["content","current","title","url"])||e.isFunction(t)||(s[n]=t)})),LP.ajax({url:this.get("url"),action:"complete-item",data:s,dataType:"json",success:function(s){LP.Hook.doAction("learn_press_course_item_completed",s,n),s=LP.Hook.applyFilters("learn_press_course_item_complete_response",s,n),e.isFunction(t.callback)&&t.callback.call(t.context,s,n)}})},start:function(t){t=e.extend({course_id:0,quiz_id:this.get("id"),security:null},t||{});var n=this._validateObject(t),s=this;LP.ajax({url:this.get("url"),action:"start-quiz",data:n,dataType:"json",success:function(n){e.isFunction(t.callback)&&t.callback.call(t.context,n,s)}})},finishQuiz:function(t){t=e.extend({course_id:0,quiz_id:this.get("id"),security:null},t||{});var n=this._validateObject(t),s=this;n=LP.Hook.applyFilters("learn_press_finish_quiz_data",n);var i=t.beforeSend||function(){};LP.ajax({url:this.get("url"),action:"finish-quiz",data:n,dataType:"json",beforeSend:i,success:function(n){LP.unblockContent(),e.isFunction(t.callback)&&t.callback.call(t.context,n,s)}})},retakeQuiz:function(t){t=e.extend({course_id:0,quiz_id:this.get("id"),security:null},t||{});var n=this._validateObject(t),s=this;LP.ajax({url:this.get("url"),action:"retake-quiz",data:n,dataType:"json",beforeSend:function(){LP.blockContent()},success:function(n){LP.unblockContent(),e.isFunction(t.callback)&&t.callback.call(t.context,n,s)}})},_toJSON:function(){s.__super__.toJSON.apply(this,arguments)},_validateObject:function(t){var n={};for(var s in t)e.isFunction(t[s])||(n[s]=t[s]);return n}}),i=Backbone.Collection.extend({model:s,current:null,len:0,initialize:function(){this.on("add",(function(e){this.listenTo(e,"change",this.onChange),e.set("index",this.len++)}),this)},onChange:function(e,t){if(1==e.get("current")){this.current=e;for(var n=0;n<this.length;n++){var s=this.at(n);s.get("id")!=e.get("id")&&(0!=s.get("current")&&(this.stopListening(s,"change",this.onChange),s.set("current",!1),this.listenTo(s,"change",this.onChange)))}}e.$el&&e.$el.toggleClass("item-current",e.get("current"))},getNextItem:function(){var e=!1;if(this.current){var t=this.current.get("index")+1;for(e=this.at(t);e&&!e.$el.hasClass("viewable")&&(t++,(e=this.at(t))&&!(t>1e3)););}return e},getPrevItem:function(){var e=!1;if(this.current){var t=this.current.get("index")-1;if(t>=0)for(e=this.at(t);!e.$el.hasClass("viewable")&&(t--,(e=this.at(t))&&!(t<0)););}return e}});t.View=Backbone.View.extend({el:"body",itemEl:null,cached:{},events:{"click .viewable .button-load-item":"_loadItem","click .prev-item, .next-item":"_loadItem","click .viewable":"_loadItem","click .section-header":"_toggleSection","click .learn-press-nav-tab":"_tabClick","click .button-retake-course":"_retakeCourse","click .button-finish-course":"_finishCourse","click .learn-press-content-item-title .lp-expand":"_expand"},itemLoading:0,currentItem:null,initialize:function(){var t=this.$(".course-item");(_.bindAll(this,"receiveMessage","pushContent","onPopState","updateItemContent","_tabClick","_showPopup","removePopup"),this.itemEl=this.$("#learn-press-content-item"),this.model.items.forEach((function(e,n){e.course=this,e.$el=t.filter(".course-item-"+e.get("id"))}),this),this._initHooks(),this._loadDefaultContent(),void 0!==window.onpopstate&&e(window).on("popstate",this.onPopState),LP.Hook.addAction("learn_press_receive_message",this.receiveMessage),"undefined"!=typeof localStorage)&&("yes"==localStorage.getItem("lp-item-expanded")&&this.expand(!0))},receiveMessage:function(e){"update-course"===e.messageType&&this.update(e)},update:function(t){if(t){var n=t.items?t.items.length:0,s=0,i={},o=this.$(".course-progress").find(".number, .percentage-sign"),r=this.$(".items-progress").find(".number, .percentage-sign");if(0!=o.length){o[0].childNodes[0].nodeValue=parseInt(t.results),this.$(".course-progress .lp-progress-value").width(parseInt(t.results)+"%"),t.items&&t.items.forEach((function(t){var n=this.$(".course-item.course-item-"+t.id),s=n.find(".item-status"),o=(s[0].className+"").replace(/(item-status-[^\s]*)/g,"").trim();i[t.section_id]||(i[t.section_id]=[0,0]),t.status&&(o+=" item-status-"+t.status),"completed"===t.status?n.addClass("item-has-status item-completed"):t.status?n.addClass("item-has-status").removeClass("item-completed"):n.removeClass("item-has-status").removeClass("item-completed"),"lp_quiz"===t.type&&n.find(".item-result").html(LP.Hook.applyFilters("item_result_text",t.results)),s[0].className=o,-1!=e.inArray(t.status,["completed","failed","passed"])&&i[t.section_id][1]++,t.status&&"viewed"!=t.status?n.addClass("item-has-result"):n.removeClass("item-has-result"),i[t.section_id][0]++}),this),this.$(".curriculum-sections .section").each((function(){var t=e(this),n=t.data("id"),o=i[n];o&&(s+=o[1],t.find(".section-header span.step").html(LP.Hook.applyFilters("section_header_span_text",o[1]+"/"+o[0])))})),r.eq(0).html(t.completed_items_text.replace("%d",s).replace("%d",n));var a=parseInt(this.$(".course-progress .lp-course-progress").data("passing-condition"));if(t.grade){var c=this.$(".grade").html(t.grade_html),l=c[0].className.replace(/passed|failed|in-progress/,"")+" "+t.grade;c[0].className=l}this.$(".button-finish-course").toggleClass("hide-if-js",!(t.results>=a)),t.setUrl&&LP.setUrl(t.setUrl)}}},getHash:function(e){var t=this.model.get("url");return e.replace(t,"")},onPopState:function(){this.getHash(window.location.href)},pushContent:function(e){var t=this.getHash(e);t&&(this.cached[t]=Math.random())},_expand:function(e){e&&e.preventDefault(),this.expand()},expand:function(t){void 0===t&&(t=!window.parent.jQuery("#popup-main").hasClass("expand")),window.parent.jQuery("#popup-main").toggleClass("expand",t),e("#learn-press-content-item").toggleClass("expand",t),localStorage&&localStorage.setItem("lp-item-expanded",t?"yes":"no")},_initHooks:function(){LP.Hook.addAction("learn_press_update_item_content",this.updateItemContent),LP.Hook.addAction("learn_press_set_location_url",this.pushContent),e(document).on("learn_press_popup_course_remove",this.removePopup)},_loadDefaultContent:function(){var e=this;setTimeout((function(){e.$(".course-item.item-current .button-load-item").trigger("click",{force:!0})}),500)},_getItemId:function(e){var t=e.hasClass("button-load-item")?e.data("id"):e.find(".button-load-item").data("id");return t||(t=e.hasClass("lp-label-preview")?e.closest(".course-item").find(".button-load-item").data("id"):0),t},_loadItem:function(t,n){t.preventDefault();var s=this,i=e(t.target),o=this._getItemId(i);if(n=n||{force:!1},o&&!this.itemLoading&&(!i.closest(".course-item").hasClass("item-current")||n.force)){if(this.blockContent(),this.currentItem){var r=this.currentItem.get("content");r&&r.detach()}this.itemLoading=o,this.currentItem=this.model.getItem(o),this.showPopup();var a=this.currentItem.get("content"),c=!(a&&a.length);a||(a=e("<iframe webkitallowfullscreen mozallowfullscreen allowfullscreen />"),this.currentItem.set("content",a)),s.viewItem(o),this.$("#popup-content-inner").html(a),c&&a.attr("src",LP.addQueryVar("content-item-only","yes",this.currentItem.get("url"))),a.unbind("load").load((function(){s.itemLoading=0}))}},viewItem:function(e,t){var n=this.model.getItem(e);return n&&n.set("current",!0),this.itemEl.show(),this.currentItem=n,this.$(".item-current").removeClass("item-current"),this.$('.course-item [data-id="'+n.get("id")+'"]').closest(".course-item").addClass("item-current"),this.$("#course-curriculum-popup").attr("data-item-id",n.get("id")),this.updateUrl(),this.updateFooterNav(),"lp_quiz"===n.get("type")&&this.loadQuiz(),n},_completeItem:function(t){var n=this,s=e(t.target),i=s.data("security"),o=this.getCurrentSection();s.closest(".course-item");LP.blockContent(),this.currentItem.complete({security:i,course_id:this.model.get("id"),section_id:o.length?o.data("id"):0,callback:function(t,s){"success"===t.result&&(s.$el.removeClass("item-started").addClass("item-completed focus off"),_.delay((function(e){e.$el.removeClass("focus off")}),3e3,s),n.$(".learn-press-course-results-progress").replaceWith(e(t.html.progress)),o.find(".section-header").replaceWith(e(t.html.section_header)),n.$(".learn-press-course-buttons").replaceWith(e(t.html.buttons)),n.currentItem.set("content",e(t.html.content))),LP.unblockContent()}})},_toggleSection:function(t){var n=e(t.target).closest(".section-header"),s=n.siblings("ul.section-content");n.find(".collapse").toggleClass("plus"),s.slideToggle()},_tabClick:function(t){var n=e(t.target).closest(".learn-press-nav-tab").data("tab");"overview"===n||"curriculum"===n&&this.currentItem},_retakeCourse:function(t){t.preventDefault();var n=this;jConfirm(learn_press_single_course_localize.confirm_retake_course.message,learn_press_single_course_localize.confirm_retake_course.title,(function(s){if(s){var i={data:e(t.target).data(),callback:function(e){"success"===e.result&&e.redirect&&LP.reload(e.redirect)}};n.model.retakeCourse(i)}}))},_finishCourse:function(t){t.preventDefault();var n=this;jConfirm(learn_press_single_course_localize.confirm_finish_course.message,learn_press_single_course_localize.confirm_finish_course.title,(function(s){if(s){var i={data:e(t.target).data(),callback:function(e){"success"===e.result&&e.redirect&&LP.reload(e.redirect)}};n.model.finishCourse(i)}}))},_showPopup:function(e){e.preventDefault();new t.ModelPopup},showPopup:function(){this.popup||(this.popup=new t.Popup({model:new t.ModelPopup,course:this}))},loadQuiz:function(){window.$Quiz&&window.$Quiz.destroy(),void 0!==window.LP_Quiz_Params&&(window.$Quiz=new LP_Quiz(window.LP_Quiz_Params))},removePopup:function(){this.popup=null,this.model.items.forEach((function(e){e.set("current",!1)}))},getCurrentSection:function(){return this.currentItem.$el.closest(".section")},updateItemContent:function(e){this.$("#popup-content-inner").html(e.get("content"))},updateFooterNav:function(){var e=this.model.getPrevItem(),t=this.model.getNextItem();this.$("#popup-footer").find(".prev-item, .next-item").remove(),e&&this.$("#popup-footer").append(n("course-prev-item",e.toJSON())),t&&this.$("#popup-footer").append(n("course-next-item",t.toJSON()))},updateUrl:function(e){!e&&this.currentItem&&(e=LP.Hook.applyFilters("learn_press_get_current_item_url",this.currentItem.get("url"),this.currentItem)),e&&LP.setUrl(e)},blockContent:function(){LP.blockContent()},unblockContent:function(){LP.unblockContent()}}),t.Model=Backbone.Model.extend({items:null,initialize:function(){this.createItems()},createItems:function(){this.items=new i,this.items.add(this.get("items"))},retakeCourse:function(t){var n=this;LP.ajax({url:this.get("url"),action:"retake-course",data:t.data,dataType:"json",beforeSend:function(){LP.blockContent()},success:function(s){LP.unblockContent(),e.isFunction(t.callback)&&t.callback.call(t.context,s,n)}})},finishCourse:function(t){var n=this;LP.ajax({url:this.get("url"),action:"finish-course",data:t.data,dataType:"json",beforeSend:function(){LP.blockContent()},success:function(s){LP.unblockContent(),e.isFunction(t.callback)&&t.callback.call(t.context,s,n)}})},getItem:function(t){return e.isPlainObject(t)?this.items.findWhere(t):this.items.findWhere({id:t})},getNextItem:function(){return this.items.getNextItem()},getPrevItem:function(){return this.items.getPrevItem()},getItems:function(e){return void 0===e?this.items:this.items.where(e)},getCurrent:function(){}}),t.Popup=Backbone.View.extend({course:null,events:{"click .popup-close":"_closePopup","click .sidebar-hide-btn":"_closeSidebar","click .sidebar-show-btn":"_showSidebar"},initialize:function(e){_.bindAll(this,"_ajaxLoadItemSuccess"),this.course=e.course,this.render()},render:function(){e(".learn-press-content-item-summary").remove(),this.$el.attr("tabindex","0").append(n("curriculum-popup",{})).css({}).appendTo(e(document.body)),this.curriculumPlaceholder=e("<span />"),this.progressPlaceholder=e("<span />");var t=this.course.$("#learn-press-course-curriculum"),s=this.course.$(".learn-press-course-results-progress");this.progressPlaceholder.insertAfter(s),s.appendTo(this.$("#popup-sidebar")),this.curriculumPlaceholder.insertAfter(t),t.appendTo(this.$("#popup-sidebar")),LP.blockContent(),e(".sidebar-show-btn").hide(),e(document).on("learn_press_unblock_content",this.hideScrollBar)},_closePopup:function(t){t.preventDefault(),LP.setUrl(this.course.model.get("url")),e("#learn-press-content-item").hide(),this.curriculumPlaceholder.replaceWith(this.$("#learn-press-course-curriculum")),this.progressPlaceholder.replaceWith(this.$(".learn-press-course-results-progress")),this.undelegateEvents(),this.remove(),LP.unblockContent(),e("html, body").css("overflow",""),e(document).off("focusin").trigger("learn_press_popup_course_remove").unbind("learn_press_unblock_content",this.hideScrollBar)},hideScrollBar:function(){e("html, body").each((function(){e(this).css("overflow","hidden")}))},_closeSidebar:function(t){t.preventDefault(),e("#popup-sidebar").stop().animate({"margin-left":-350}),e("#popup-main").stop().animate({left:"0px"}),e("#popup-main .sidebar-show-btn").css("display","inline-block")},_showSidebar:function(t){t.preventDefault(),e("#popup-sidebar").stop().animate({"margin-left":"0"}),e("#popup-main").stop().animate({left:"350px"}),e("#popup-main .sidebar-show-btn").css("display","none")},_loadItem:function(t){var n=e("<iframe webkitallowfullscreen mozallowfullscreen allowfullscreen />").src(e(t.target).attr("href")+"?content-item-only=yes");this.$("#popup-content-inner").html(n)},_ajaxLoadItemSuccess:function(t){this.$("#popup-content-inner").html(e(t).contents().find(".lp_course"))}}),t.ModelPopup=Backbone.Model.extend({initialize:function(){}}),LP.Course=t,e(document).ready((function(){void 0!==window.LP_Course_Params&&e(document).ready((function(){LP.$LP_Course=new t(LP_Course_Params),LP.Hook.doAction("learn_press_course_initialize",LP.$LP_Course),e(window).trigger("resize.check-lines")}))})),e(document).ajaxComplete((function(t,n,s){s.data&&s.data.match(/lp-ajax=/)&&(e(document).trigger("ready"),e(window).trigger("resize"),LP.unblockContent(),e(".learn-press-tooltip").LP_Tooltip({offset:[24,24]}))})).ajaxError((function(){LP.unblockContent()}))}(jQuery);