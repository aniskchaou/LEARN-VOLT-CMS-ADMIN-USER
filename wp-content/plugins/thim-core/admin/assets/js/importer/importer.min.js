!function(d){function i(t,e){d(window).trigger(t,e)}var t=Backbone.Model.extend({initialize:function(){},defaults:{plugins_required:[],demo:null,packages:[]}}),e=Backbone.Model.extend({initialize:function(){},defaults:{demos:[]}}),s=Backbone.View.extend({el:".tc-modal-importer",doing_import:!1,current_request:null,model:{},events:{"click .close":"close","click #start-import":"import","click #retry-import":"retry_import","click .package:not(.disabled, .obligatory)":"onChangePackage"},try_again_step:0,try_again_step_max:50,retry:0,retry_max:2,failed:!1,message_error:!1,template:function(t){var e=this.$el.attr("data-template");return wp.template(e)(t)},initialize:function(){this.model=new t(thim_importer_data),this.render();var i=this;d(document).on("click",".tc-modal-importer .tc-open-modal",function(t){i.close()}),d(window).on("thim_core_open_modal",function(t,e){"tc-send-feedback"===e&&(d(document).find("#tc-send-feedback .content textarea").text(i.message_error),d(document).find("#tc-send-feedback .developer-access input").trigger("click"),i.close())})},onChangePackage:function(t){var e,i,s;this.doing_import||((i=(e=this.$(t.currentTarget)).find("input")).prop("checked",!i.prop("checked")),s=e.data("package"),this._checkRequired(s))},_checkRequired:function(t){var e,i,s,r=this.$('.package[data-required="'+t+'"]');0!==r.length&&(e=r.data("package"),i=this.$("#importer-"+e),s=this.$("#importer-"+t).prop("checked"),i.attr("disabled",!s),r.toggleClass("disabled"))},open:function(t){this.$el.addClass("md-show"),this.$(".main").scrollTop(0),d(".thim-dashboard").addClass("thim-modal-open"),this.model.set("demo",t),this.update()},close:function(){if(this.doing_import&&!window.confirm(thim_importer_data.confirm_close))return;this._finish(),this.$el.removeClass("md-show"),d(".thim-dashboard").removeClass("thim-modal-open"),this.reset()},reset:function(){this.doing_import=!1,this.$("input").attr("disabled",!1),this.$("#start-import").attr("disabled",!1),this.$("input").prop("checked",!0),this.$(".package").removeClass("disabled").removeAttr("data-status").removeAttr("data-percentage"),this.$el.removeClass("importing completed"),this.$(".package-progress-bar").css("width",0)},update:function(){var t=this.model.get("demo");this.$(".demo-name").text(t.title);var e=t.revsliders||[];this.$(".package.revslider").removeClass("disabled"),e.length||this.$(".package.revslider").addClass("disabled"),this.updatePluginsRequired(t)},import:function(){this._updatePackages(),this.$("#start-import").attr("disabled",!0),this.$el.addClass("importing"),this.$("input").attr("disabled",!0),this._startImport()},retry_import:function(){this.reset(),this.retry++,this.import()},_updatePackages:function(){var e=[];this.$(".package:not(.disabled) input:checked").each(function(){var t=d(this).parents(".package").data("package");e.push(t)}),this.model.set("packages",e),0===e.length?this.$("#start-import").attr("disabled",!0):this.$("#start-import").attr("disabled",!1)},_startImport:function(){this.doing_import=!0,this._initImport()},_initImport:function(){this._lockWindow();var t=this.model.get("demo"),e=this.model.get("packages"),i=this,s=this.failed;this.current_request=d.ajax({url:this.model.get("url_ajax"),method:"POST",data:{action:"thim_importer",demo:t.key,packages:e,retry:s},dataType:"text"}).success(function(t){(t=i._parseJSON(t)).success||!1||console.error("Failed!");var e=t.data.next;if(!e)return i._notifySuccess();i._stepByStep(e)}).error(function(t){return i._notifyErrorAjax(t)})},_stepByStep:function(o){this.$(".package."+o).attr("data-status","running"),this._scrollTo(o);var l=this;this.current_request=d.ajax({url:this.model.get("url_ajax"),method:"POST",dataType:"text",data:{action:"thim_importer",time:(new Date).getTime()}}).success(function(t){if(!(t=l._parseJSON(t)))return l.try_again_step+=1,l.try_again_step>l.try_again_step_max?l._notifyError({code:"#002",title:"Something went wrong!"}):l._stepByStep(o);var e=t.success||!1,i=t.data;if(!e){l.try_again_step+=1;var s=i.code||"";return l.try_again_step>l.try_again_step_max||s.includes("008_DOWNLOAD_FAILED")?l._notifyError(i):l._stepByStep(o)}var r,a=i.done||!1;a?l.$(".package."+a).attr("data-status","completed").attr({"data-percentage":"100%"}).find(".package-progress-bar").css("width","100%"):i.ext&&-1!==d.inArray(i.next,["media","main_content","plugins"])&&(r=i.ext.percentage||2,l.$(".package."+i.next).attr({"data-percentage":r+"%"}).find(".package-progress-bar").css("width",r+"%"));var n=i.next;if(!n)return l._notifySuccess();l._stepByStep(n)}).error(function(t){return l.try_again_step+=1,l.try_again_step>l.try_again_step_max?l._notifyErrorAjax(t):l._stepByStep(o)})},_scrollTo:function(t){var e=this.$(".main"),i=d(".package."+t);e.stop().animate({scrollTop:i.offset().top-e.offset().top+e.scrollTop()},500)},_parseJSON:function(e){var t=e.match(/<!-- THIM_IMPORT_START -->(.*)<!-- THIM_IMPORT_END -->/);try{e=t?d.parseJSON(t[1]):d.parseJSON(e)}catch(t){e=!1}return e},_notifyErrorAjax:function(t){var e=thim_importer_data.details_error,i={title:e.title};return 200===t.status?(i.code=e.code.request,this._notifyError(i)):!(200<t.status)||(this.failed=!0,i.code=e.code.server,this.retry<this.retry_max?this._notify_retry(e.try_again):this._notifyError(i))},_notify_retry:function(t){return this.$(".wrapper-finish .details-error").find(".how-to").html(t).show(),this.$(".wrapper-finish").removeClass("success").addClass("failed retry"),this._finish(),!0},_notifyError:function(t){this._emitEvent("thim_importer_failed");var e=this.$(".wrapper-finish .details-error");e.find(".get-support .error-code").text(t.code),e.find("h3").text(t.title);var i=t.how_to||!1;return i?e.find(".how-to").html(i).show():e.find(".how-to").hide(),this.$(".wrapper-finish").removeClass("success retry").addClass("failed"),this._finish(),this.message_error="[Import Demo Content] "+t.title+" with code "+t.code+".",!0},_notifySuccess:function(){return this.failed=!1,this._emitEvent("thim_importer_complete",this.model.get("demo")),this.$(".wrapper-finish").removeClass("failed").addClass("success"),this._finish(),!0},_finish:function(){return this._forceStop(),!0},_forceStop:function(){this.$el.removeClass("importing").addClass("completed"),this.doing_import=!1,this._unlockWindow(),this.current_request&&this.current_request.abort()},_lockWindow:function(){window.onbeforeunload=function(){return"The import process will cause errors if you leave this page!"}},_unlockWindow:function(){window.onbeforeunload=null},_emitEvent:function(t,e){d(window).trigger(t,e)},updatePluginsRequired:function(){},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),r=Backbone.View.extend({el:".tc-modal-importer-uninstall",model:{},current_request:!1,doing_uninstall:!1,events:{"click .close":"close","click .tc-start":"startUninstall"},template:function(t){var e=this.$el.attr("data-template");return wp.template(e)(t)},initialize:function(){this.model=new t(thim_importer_data),this.render()},open:function(){this.$el.addClass("md-show"),this.$(".main").scrollTop(0),this.$(".tc-start").removeClass("updating-message").attr("disabled",!1),d(".thim-dashboard").addClass("thim-modal-open")},close:function(){if(this.doing_uninstall&&!window.confirm(thim_importer_data.confirm_close))return;this.$el.removeClass("md-show"),d(".thim-dashboard").removeClass("thim-modal-open"),this.reset()},startUninstall:function(){this.$(".tc-start").addClass("updating-message").attr("disabled",!0);var e=this;e.$el.addClass("running"),this.current_request=d.ajax({url:this.model.get("url_ajax"),method:"POST",dataType:"text",data:{action:"thim_importer_uninstall"}}).success(function(t){(t=function(e){var t=e.match(/<!-- THIM_IMPORT_START -->(.*)<!-- THIM_IMPORT_END -->/);try{e=t?d.parseJSON(t[1]):d.parseJSON(e)}catch(t){e=!1}return e}(t)).success?(e.notify("success",thim_importer_data.uninstall_successful),i("thim_uninstall_demo_successful")):(e.notify("error",thim_importer_data.uninstall_failed),i("thim_uninstall_demo_failed"))}).error(function(t){"abort"!==t.statusText&&(e.$(".tc-start").attr("disabled",!1),e.notify("error",thim_importer_data.something_went_wrong),i("thim_uninstall_demo_failed"))}).complete(function(){e.$(".tc-start").removeClass("updating-message"),e.$el.removeClass("running"),i("thim_uninstall_demo_complete")})},notify:function(t,e){switch(t){case"error":this.$(".tc-success").hide(),this.$(".tc-error").show().find(".content").text(e);break;default:this.$(".tc-error").hide(),this.$(".tc-success").show().find(".content").text(e)}},reset:function(){this.$(".tc-start").attr("disabled",!1),this.$(".notifications > *").hide()},render:function(){this.$el.html(this.template({}))}}),a=Backbone.View.extend({el:".tc-importer-wrapper",form_install:null,form_uninstall:null,model:null,audio_complete:null,events:{"click .action-import":"openInstall","click .thim-screenshot":"openInstall","click .btn-uninstall":"openUninstall"},initialize:function(){this.audio_complete=new Audio("https://thimpresswp.github.io/thim-core/static/complete.mp3"),d(window).on("thim_importer_complete",this.onImportSuccess.bind(this)),d(window).on("thim_uninstall_demo_successful",this.onUninstallSuccess.bind(this)),this.model.on("change:installed",this.updateDemoInstalled.bind(this)),this.render(),this.form_install=new s,this.form_uninstall=new r},template:function(t){var e=this.$el.attr("data-template");return wp.template(e)(t)},render:function(){this.$el.html(this.template(this.model.toJSON()))},onImportSuccess:function(t,e){this.audio_complete.play(),this.model.set("installed",e.key)},onUninstallSuccess:function(t){this.model.set("installed",!1),this.render()},updateDemoInstalled:function(){this.model.get("installed");this.$(".thim-demo").removeClass("installed active"),this.render()},openUninstall:function(t){this.form_uninstall.open()},openInstall:function(t){var e,i,s;t.preventDefault(),Thim_Core.check_active()&&(e=t.target,i=d(e).closest(".thim-demo").data("thim-demo"),s=this.model.get("demos"),this.form_install.open(s[i]))}});d(document).ready(function(){new a({model:new e(thim_importer)})})}(jQuery);